---
layout: post
title:  分布式事务
categories: 其他
description:  分布式事务
keywords: 
---

引言

刷题的时候遇到了分布式事务，所以查找了相关的知识点，记录一下 ，主要参考了公众号“程序员小灰”

# 分布式事务

### 1.事务

事务是作为单个逻辑单元执行的一组操作，要么全成功要么全失败

事务包括四个特性原子性，一致性，持久性，隔离性

单机数据源的一致性考打及食物来保证，多数据源的一致性就要依靠分布式事务

### 2.分布式事务

用于在分布式系统中保证不同节点之间的数据一致性。分布式事务的实现有很多种，最具代表性的是XA分布式事务协议

XA协议包含两阶段提交（2PC）和三阶段提交（3PC）两种实现

### 3.XA协议

包含两个角色：事务协调这和事务参与者：

第一阶段：

作为事务协调者的节点会首先向所有的参与者节点发送Prepare请求。

在接到Prepare请求之后，每一个参与者节点会各自执行与事务有关的数据更新，写入Undo Log和Redo Log。如果参与者执行成功，暂时不提交事务，而是向事务协调节点返回“完成”消息。

当事务协调者接到了所有参与者的返回消息，整个分布式事务将会进入第二阶段。

第二阶段：

在XA分布式事务的第二阶段，如果事务协调节点在之前所收到都是正向返回，那么它将会向所有事务参与者发出Commit请求。

接到Commit请求之后，事务参与者节点会各自进行本地的事务提交，并释放锁资源。当本地事务完成提交后，将会向事务协调者返回“完成”消息。

当事务协调者接收到所有事务参与者的“完成”反馈，整个分布式事务完成。

### 4.失败情况处理

在XA的第一阶段，如果某个事务参与者反馈失败消息，说明该节点的本地事务执行不成功，必须回滚。

于是在第二阶段，事务协调节点向所有的事务参与者发送Abort请求。接收到Abort请求之后，各个事务参与者节点需要在本地进行事务的回滚操作，回滚操作依照Undo Log来进行。

### 5.XA两阶段提交的不足

性能问题：XA协议遵循强一致性。在事务执行过程中，各个节点占用着数据库资源，只有当所有节点准备完毕，事务协调者才会通知提交，参与者提交后释放资源。这样的过程有着非常明显的性能问题。

协调者单点故障：事务协调者是整个XA模型的核心，一旦事务协调者节点挂掉，参与者收不到提交或是回滚通知，参与者会一直处于中间状态无法完成事务。

丢失消息导致的不一致问题：在XA协议的第二个阶段，如果发生局部网络问题，一部分事务参与者收到了提交消息，另一部分事务参与者没收到提交消息，那么就导致了节点之间数据的不一致。